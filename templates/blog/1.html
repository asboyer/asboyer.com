{% extends "layout.html" %}

{% block styles %}
    <link href="/static/css/tmrw_night/prism.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<section class="post">
    <div class="post-header">
        <h2 class="post-title" id="title">
            <strong>Predicting the MVP with Python</strong>
        </h2>

        <h3 class="post-author">
            Andrew Boyer
        </h3>  

        <h3 class="post-date">
            2.7.22
        </h3>  
        
    </div>

<div class="post-content">
<p class="post-text-intro" id="preface">
    My sincerest apologies for my absence on this blog, other things have been eating up my time. Thank you to everyone who supported the <a href="https://asboyer.com/blog/0" target="_blank">last post</a>. <i>Way</i> bigger things are coming soon. It is my goal to get a post up every other Monday. Without further ado, on with the highly anticipated story behind <a href="https://goatgrade.com" target="_blank">Goat Grade</a>.
    <br>
    ---
    <br>
    During February of 2021, one year ago, I created a website where I used data from <a href="https://www.basketball-reference.com/" target="_blank">Basketball Reference</a> and Python to rank NBA players based on their statistics and display my rankings online. After I uploaded my rankings to the internet, I didn't think too much of it. A few months later, the NBA MVP finalists were announced. To my surprise, my algorithm predicted the top <a href="https://www.nba.com/news/kia-mvp-ladder-nikola-jokic-finishes-no-1-among-pack-of-contenders" target="_blank">two front runners</a> in the race for most valuable player. After <a href="https://www.nba.com/kia-mvp/2021-nikola-jokic" target="_blank">Nikola Jokic</a> was announced the league MVP, it became official: a program I wrote in a weekend had predicted the league MVP months before the finalists were even announced. This is the story of how I built <a href="https://goatgrade.com" target="_blank">Goat Grade</a> and why my prediction may have actually been a total fluke after all.
</p>

<div class="post-line" style="margin-bottom: 20px"></div>

<h3 class="post-text-header" id="beginnings"><a href="/blog/1#beginnings">Beginnings</a></h3>

<p class="post-text">
    The inspiration behind this project came in multiple ways. I had just finished the first half of my junior year of high school and was looking for a new project to work on.
    <br>
    Earlier that year, I released <a href="https://github.com/asboyer/reporty" target="_blank">Reporty</a>, a Python library with tools designed for organizing and distributing visual data. The library takes in data sets or figures and generates an HTML page with said figures. There is also an option to send that page embedded in an email <a class="footnote-link" href="#footnote1" id="footlink1">[1]</a>. 
    <br>
    After wrapping up that project, I wanted to get started on something new. Building Reporty, with some help from my mentor <a class="footnote-link" href="#footnote2" id="footlink2">[2]</a>, had given me a solid introduction into the world of <a href="https://en.wikipedia.org/wiki/Data_science" target="_blank">data science</a>. Still, I hadn't quite undertaken a project where I actually organized, cleaned, and modeled data from a real data set. Reporty used figures that were <i>already</i> made with existing (or even fake) data <a class="footnote-link" href="#footnote3" id="footlink3">[3]</a>.
    <br>
    So, I contacted a friend from Boise, Idaho <a class="footnote-link" href="#footnote4" id="footlink4">[4]</a>, and asked him if he wanted to collaborate on some kind of data science project. At first, we didn't have any particular idea of what we wanted to do. We bounced around a few ideas and lingered on the subject of web scraping, which both of us interested in, but unfamiliar with. What better way to learn than through building a project? We zeroed in on scraping basketball statistics and using that data to generate some kind of fun set of predictions. We frequently debated who the best basketball player in the world was, so why not settle this debate with some cold hard evidence. The idea of "Goat" (standing for "Greatest of All Time") Grade was born.
</p>
<br>
<h3 class="post-text-header" id="webscraping"><a href="/blog/1#webscraping">Scraping the data</a></h3>


<p class="post-text">
    Before we talk about how we scraped the statistics, allow me to explain "<a href="https://en.wikipedia.org/wiki/Web_scraping" target="_blank">web scraping</a>" in simple terms. 
    <br>
    As we all know, the Internet contains almost an unlimited amount information. Whether its Chic-Fil-A's hours on Sunday or the <em>Ocean's Eleven</em> IMDb rating, the information we seek is somewhere on a computer connected to the internet, a simple Google search away. 
    <br>
    But, what if we could automate this process? Is it really possible to write a program to get the <em>Ocean's Eleven</em> rating without even leaving your terminal? Could it also alert me anytime the rating changes? The answer to these questions is absolutely, thanks to web scraping, which is a technique used to automate the process of extracting data from a website <a class="footnote-link" href="#footnote5" id="footlink5">[5]</a>.
    <br>
    Okay, so now that we know what web scraping is, <i>how</i> do we actually do it with Python? Thanks to some useful libraries, its quite simple. 
    <br>
    In our case, we wanted to scrape statistics from <a href="https://www.basketball-reference.com/" target="_blank">Basketball Reference</a>. We knew that the player statistics page looked like this:
    </p>
    <a class="post-link" style="width: 80%" href="https://www.basketball-reference.com/leagues/NBA_2021_per_game.html" target="_blank">
        <img  src="/static/img/blog/python-mvp/refrence.png">
    </a>
    <figcaption>Screenshot from Basketball Reference</figcaption>
    <br>
    <p class="post-text">
        The data is displayed in a table format, where each row contains a specific player's stats. The table headers are the categories and the table rows are the statistics.
    </p>
    <br>
    <p class="post-text">
    The following code <a class="footnote-link" href="#footnote6" id="footlink6">[6]</a> imports the <a href="https://docs.python.org/3/library/urllib.html" target="_blank">urllib</a> and <a href="https://beautiful-soup-4.readthedocs.io/en/latest/" target="_blank">Beautiful Soup</a> Python modules, visits the website, and parses through the HTML. The code extracts all of the headers and stores them in a list.

</p>

<div class="code-block">
<pre><code class="language-python">from urllib.request import urlopen
from bs4 import BeautifulSoup

year = 2021
url = f'https://www.basketball-reference.com/leagues/NBA_{year}_per_game.html'
html = urlopen(url)
soup = BeautifulSoup(html, 'html.parser')

# 'th' means table headers and 'tr' means table rows
headers = [th.getText() for th in soup.findAll('tr', limit=2)[0].findAll('th')]
headers = headers[1:]
</code></pre>
</div>

<div class="code-block">
<pre><code class="language-bash">headers = ['Player', 'Pos', 'Age', 'Tm', 'G', 'GS', 'MP', 'FG', 'FGA', 'FG%', '3P', '3PA', '3P%', '2P', '2PA', '2P%', 'eFG%', 'FT', 'FTA', 'FT%', 'ORB', 'DRB', 'TRB', 'AST', 'STL', 'BLK', 'TOV', 'PF', 'PTS']
</code></pre>
</div>

<p class="post-text">
    After we collected all the headers (the statistical categories we were interested in), we needed to gather the actual data, which was stored in the table rows. <a href="https://beautiful-soup-4.readthedocs.io/en/latest/" target="_blank">Beautiful Soup</a> made it easy to scrape the HTML code for each row. 
</p>

<div class="code-block">
<pre><code class="language-python">rows = soup.findAll('tr')[1:]
</code></pre>
</div>

<p class="post-text">
    The <code class="language-python">rows</code> list contains all of the HTML code for each row in the table. A single item from this list would look like this:
</p>

<div class="code-block">
<pre><code class="language-html">&lt;tr class="full_table"&gt;
    &lt;th class="right" csk="140" data-stat="ranker" scope="row"&gt;140&lt;/th&gt;
    &lt;td class="left" csk="Durant,Kevin" data-append-csv="duranke01" data-stat="player"&gt;
        &lt;a href="/players/d/duranke01.html"&gt;Kevin Durant&lt;/a&gt;
    &lt;/td&gt;
    &lt;td class="center" data-stat="pos"&gt;PF&lt;/td&gt;
    &lt;td class="right" data-stat="age"&gt;32&lt;/td&gt;
    &lt;td class="left" data-stat="team_id"&gt;&lt;a href="/teams/BRK/2021.html"&gt;BRK&lt;/a&gt;&lt;/td&gt;
    &lt;td class="right" data-stat="g"&gt;35&lt;/td&gt;
    &lt;td class="right" data-stat="gs"&gt;32&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="mp_per_g"&gt;33.1&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="fg_per_g"&gt;9.3&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="fga_per_g"&gt;17.2&lt;/td&gt;
    &lt;td class="right" data-stat="fg_pct"&gt;.537&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="fg3_per_g"&gt;2.4&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="fg3a_per_g"&gt;5.4&lt;/td&gt;
    &lt;td class="right" data-stat="fg3_pct"&gt;.450&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="fg2_per_g"&gt;6.8&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="fg2a_per_g"&gt;11.8&lt;/td&gt;
    &lt;td class="right" data-stat="fg2_pct"&gt;.577&lt;/td&gt;
    &lt;td class="right" data-stat="efg_pct"&gt;.608&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="ft_per_g"&gt;6.0&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="fta_per_g"&gt;6.8&lt;/td&gt;
    &lt;td class="right" data-stat="ft_pct"&gt;.882&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="orb_per_g"&gt;0.4&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="drb_per_g"&gt;6.7&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="trb_per_g"&gt;7.1&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="ast_per_g"&gt;5.6&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="stl_per_g"&gt;0.7&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="blk_per_g"&gt;1.3&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="tov_per_g"&gt;3.4&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="pf_per_g"&gt;2.0&lt;/td&gt;
    &lt;td class="right non_qual" data-stat="pts_per_g"&gt;26.9&lt;/td&gt;
&lt;/tr&gt;
</code></pre>
</div>

<p class="post-text">
    Would you look at that! All the data is there, we just needed to clean it up by getting rid of all the HTML code. I extracted the data and stored it in the <code class="language-python">stats</code> dictionary by looping through each row and extracting all the text between the <code class="language-html">&lt;td&gt;</code> tags, which defines a standard cell in an HTML table. Then, I create a new sub-dictionary for each player and fill each category in the <code class="language-python">headers</code> list with the player's data.
</p>


<div class="code-block">
<pre><code class="language-python">stats = {}

for i in range(len(rows)):
    tds = rows[i].findAll('td')
    if len(tds) > 0:
        h = 0
        name = tds[0].getText()
        stats[name] = {}
        for td in tds:
            stats[name][headers[h]] = td.getText()
            h += 1
</code></pre>
</div>

<p class="post-text">
    The <code class="language-python">stats</code> dictionary now contains every player's statistics, neatly organized in the format we want <a class="footnote-link" href="#footnote7" id="footlink7">[7]</a>. Here is what <code class="language-python">stats["Kevin Durant"]</code> would look like:
</p>

<div class="code-block">
<pre><code class="language-json">{
    'Player': 'Kevin Durant',
    'Pos': 'PF',
    'Age': '32',
    'Tm': 'BRK',
    'G': '35',
    'GS': '32',
    'MP': '33.1',
    'FG': '9.3',
    'FGA': '17.2',
    'FG%': '.537',
    '3P': '2.4',
    '3PA': '5.4',
    '3P%': '.450',
    '2P': '6.8',
    '2PA': '11.8',
    '2P%': '.577',
    'eFG%': '.608',
    'FT': '6.0',
    'FTA': '6.8',
    'FT%': '.882',
    'ORB': '0.4',
    'DRB': '6.7',
    'TRB': '7.1',
    'AST': '5.6',
    'STL': '0.7',
    'BLK': '1.3',
    'TOV': '3.4',
    'PF': '2.0',
    'PTS': '26.9'
}
</code></pre>
</div>

<p class="post-text">
    All that remains is dumping this dictionary into a JSON file for storage and we can start working with our data.
</p>

<div class="code-block">
<pre><code class="language-python">with open('stats.json', 'w+', encoding='utf8') as file:
    file.write(json.dumps(stats, ensure_ascii=False, indent=4))
</code></pre>
</div>

<p class="post-text">
    This isn't all the data available to us. Basketball Reference also keeps <a href="https://www.basketball-reference.com/leagues/NBA_2021_advanced.html" target="_blank">advanced stats</a>. We can scrape this in the exact same way as before and then combine our data. Just change the url variable like so:
</p>

<div class="code-block">
<pre><code class="language-python">url = f"https://www.basketball-reference.com/leagues/NBA_{year}_advanced.html"
</code></pre>
</div>

<p class="post-text">
    Now, we can combine our advanced stats with the regular stats like this: 
</p>

<div class="code-block">
<pre><code class="language-python">for player in stats:
    stats[player].update(advanced_stats[player])
</code></pre>
</div>

<p class="post-text">
    With the added categories, a single player's sub-dictionary looks like this:
</p>

<div class="code-block">
<pre><code class="language-json">{
    'Player': 'Kevin Durant',
    'Pos': 'PF',
    'Age': '32',
    'Tm': 'BRK',
    'G': '35',
    'GS': '32',
    'MP': '33.1',
    'FG': '9.3',
    'FGA': '17.2',
    'FG%': '.537',
    '3P': '2.4',
    '3PA': '5.4',
    '3P%': '.450',
    '2P': '6.8',
    '2PA': '11.8',
    '2P%': '.577',
    'eFG%': '.608',
    'FT': '6.0',
    'FTA': '6.8',
    'FT%': '.882',
    'ORB': '0.4',
    'DRB': '6.7',
    'TRB': '7.1',
    'AST': '5.6',
    'STL': '0.7',
    'BLK': '1.3',
    'TOV': '3.4',
    'PF': '2.0',
    'PTS': '26.9',
    'TMP': '1157',
    'PER': '26.4',
    'TS%': '.666',
    '3PAr': '.313',
    'FTr': '.395',
    'ORB%': '1.3',
    'DRB%': '21.3',
    'TRB%': '11.8',
    'AST%': '27.5',
    'STL%': '1.0',
    'BLK%': '3.4',
    'TOV%': '14.5',
    'USG%': '31.2',
    'OWS': '3.7',
    'DWS': '1.2',
    'WS': '5.0',
    'WS/48': '.206',
    'OBPM': '6.4',
    'DBPM': '0.8',
    'BPM': '7.2',
    'VORP': '2.7'
}
</code></pre>
</div>


<h3 class="post-text-header" id="rankings"><a href="/blog/1#rankings">Ranking the players</a></h3>

<p class="post-text">
    We now need to develop some kind of algorithm to decide which player better is the best overall. The first step in doing this is discerning what statistical categories are actually important and what categories don't matter. I didn't really put too much thought into this. I'm definitely going to do some more research and tweak this algorithm later. The thirteen categories that I thought would be most important were:
</p>
<br>
<ul class="blog_list">
  <li>- points</li>
  <li>- assists</li>
  <li>- total rebounds</li>
  <li>- field goal %</li>
  <li>- free throw %</li>
  <li>- three point %</li>
  <li>- steals</li>
  <li>- blocks</li>
  <li>- minutes played</li>
  <li>- player efficiency rating</li>
  <li>- true shooting %</li>
  <li>- win shares</li>
  <li>- box plus/minus</li>


</ul>

























<div class="post-line"></div>


<p class="footnote" id="footnote1">
<a class="footnote-link" href="#footlink1">[1]</a> I am still improving Reporty. There may be a blog post in the near future explaining how I built it and what my plans are for the future of the library. Check out our <a href="https://github.com/asboyer/reporty" target="_blank">GitHub</a> and fork the repository if you would like to contribute!
</p>

<br>

<p class="footnote" id="footnote2">
<a class="footnote-link" href="#footlink2">[2]</a> <a href="https://github.com/btengels" target="_blank">btengels</a>
</p>

<br>

<p class="footnote" id="footnote3">
<a class="footnote-link" href="#footlink3">[3]</a> That being said, building <a href="https://github.com/asboyer/reporty" target="_blank">Reporty</a> taught me a lot about Python modules, image encoding, and automated emails.
</p>

<br>
<p class="footnote" id="footnote4">
<a class="footnote-link" href="#footlink4">[4]</a> <a href="https://github.com/kadebaxter" target="_blank">kadebaxter</a>
</p>
<br>

<p class="footnote" id="footnote5">
<a href="#footlink5">[5]</a> Yes, I do acknowledge there are other ways of getting information from websites. A lot of apps actually have APIs, which make things a lot easier when you want to automate the process of collecting data and information. The before mentioned IMDb problem can easily be solved with the <a href="https://imdbpy.readthedocs.io/en/latest/" target="_blank">IMDb python library</a>, which uses the IMDb API. This is what I use for my website's <a href="/movies" target="_blank">movies</a> section. I can get titles, ratings, posters, and more with just a simple Python function. I'll probably post a short tutorial on how to use my favorite APIs in the future.
</p>
<br>
<p class="footnote" id="footnote6">
<a href="#footlink6">[6]</a> I used some code from <a href="https://medium.com/analytics-vidhya/intro-to-scraping-basketball-reference-data-8adcaa79664a" target="_blank">this article</a> to get started.
</p>
<br>
<p class="footnote" id="footnote7">
<a class="footnote-link" href="#footlink7">[7]</a> Using a dictionary eliminates the duplicate players issue, which is caused by Basketball Reference having multiple rows for the same player if they switch teams mid-season. See the Basketball Reference screenshot. LaMarcus Aldridge has three rows because he played on the Spurs, Raptors, and Nets all in one season.
</p>
</div>



</section> 
{% endblock %}

{% block scripts %}
<script src="/static/js/tmrw_night/prism.js"></script>
{% endblock %}
